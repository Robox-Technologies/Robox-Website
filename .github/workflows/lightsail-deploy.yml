# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to AWS Lightsail on merge
on:
  push:
    branches:
      - master
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Deploy to AWS Lightsail
        uses: appleboy/ssh-action@2ead5e36573f08b82fbfce1504f1a4b05a647c6f
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/Robox-Website-2
            git pull origin master
            npm install

            touch .env

            echo STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }} > .env
            echo STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }} >> .env
            echo FORCE_CACHE=${{ vars.FORCE_CACHE }} >> .env
            
            echo EMAIL_HOST=${{ secrets.EMAIL_HOST }} > .env
            echo EMAIL_PORT=${{ secrets.EMAIL_PORT }} >> .env
            echo EMAIL_SECURE=${{ secrets.EMAIL_SECURE }} >> .env
            echo EMAIL_USER=${{ secrets.EMAIL_USER }} >> .env
            echo EMAIL_PASS=${{ secrets.EMAIL_PASS }} >> .env

            cat .env
          
            webpack --config build/server/webpack.config.js
            pm2 delete server 2> /dev/null || true
            pm2 start ./build/server/server.js --name "server"